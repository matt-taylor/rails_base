version: 2.1

orbs:
  ruby: circleci/ruby@1.0
  node: circleci/node@2
  cst: cst/framework@dev:phase_1

jobs:
  publish-rubygems:
    executor: cst/ruby-base
    steps:
      - cst/bundler-preamble:
          keep-lock-file: true
      - cst/wait-for-mysql
      - cst/wait-for-redis
      - run:
          name: Publish Ruby Gems
          command: |
            bin/publish_ruby_gems
  publish-github:
    executor: cst/ruby-base
    steps:
      - cst/bundler-preamble:
          keep-lock-file: true
      - cst/wait-for-mysql
      - cst/wait-for-redis
      - run:
          name: 'Get Go'
          command: |
            sudo apt-get update -qq
            sudo apt-get -y --no-install-recommends install golang-go
      - run:
          name: 'Set Git stats'
          command: |
            git config user.name $GITHUB_USER
            git config user.email $GITHUB_EMAIL
      - run:
          name: 'Download GHR'
          command: |
            curl -sSL https://github.com/tcnksm/ghr/releases/download/v0.13.0/ghr_v0.13.0_linux_amd64.tar.gz | tar xz -f - -C . ghr_v0.13.0_linux_amd64/ghr
            mv ghr_v0.13.0_linux_amd64/ghr .
            rm -rf ghr_v0.13.0_linux_amd64
            chmod 0755 ghr
      - run:
          name: Publish Git
          command: |
            export GHRLOCATION=ghr
            bin/publish_git

workflows:
  version: 2
  yeet-le-jobs:
    jobs:
      - cst/enforce-gem-version-bump
      - cst/rspec-rails-ruby:
          database-migration: true
          database-migration-command: "SKIP_CUSTOM_INIT=true bundle exec rails db:schema:load --trace"
          rspec-system-args: "SIMPLE_COV_RUN=true"
          cc-report-collect-ruby: "2.7.5-node"
          cc-report-collect-rails: "~> 6"
          matrix:
            parameters:
              ruby-version: ["2.7.5-node" , "3.0.0-node", "3.0.3-node"]
              rails-version: ["~> 5.2", "~> 6.0.0" , "~> 6"]
            exclude:
              - ruby-version: "3.0.0-node"
                rails-version: "~> 5.2"
              - ruby-version: "3.0.3-node"
                rails-version: "~> 5.2"
              - ruby-version: "3.1.0-node"
                rails-version: "~> 5.2"
            alias: required-matrix-tests
          name: test-ruby<< matrix.ruby-version >>-rails<< matrix.rails-version >>
      - publish-github:
          requires:
            - required-matrix-tests
          filters:
            branches:
              only:
                - main
      - publish-rubygems:
          requires:
            - required-matrix-tests
          filters:
            branches:
              only:
                - main
